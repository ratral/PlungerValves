# Example 2. 

The objective of this exercise is to select from three possible types of control valves (the same valve but different cylinders) the most suitable for the operation of the system.
the conditions are as follows:

  - The diameter of the valve is smaller than the diameter of the pipes, and the piping system requires a constant flow,
  - the pressures vary both upstream and downstream of the valve, and
  - Initially, only three operational points will be evaluated.
  
The steps to follow are those:

   - Step 1. Specify the variables required  to size the valve.
   - Step 2. Determine the equation constants.
   - Step 3. Determine the piping geometry factor ($F_P$).
   - Step 4. Determine the pressure drop to use for sizing ($\Delta{P_{sizing}}).$
   - Step 5. Calculate the required flow coefficient ($K_v$).

## Step 1. Specify the variables required  to size the valve.

```{r include=FALSE}

  temp <- 15.00   # °C
  elev <- 2700    # m 
  flow <- 9396    # m3/h (2.610 m3/s)
  d    <- 1.000   # m
  D1   <- 1.4     # m (DN Pipe Upstream)
  D2   <- 1.2     # m (DN Pipe Downstream)
  
  # base_data Pressures (bar)
  base_data <- tribble(
    ~measurement, ~p1,   ~p2, ~flow,
    "Min.",      1.234, 1.090,  9396,
    "Mean",      1.424, 0.636,  9396,
    "Max.",      1.778, 0.646,  9396
  ) 
    
  # Cylinder parameter/Characteristics
  
  cylinder <- tribble(
     ~typ,     ~kv.b,  ~kv.d,   ~kv.e,   ~zvs,  ~fls,
    "typ_01", -2.393,	1.389,  67.422,	 1.780,	0.617, # 0
    "typ_02", -3.893,	1.146,  61.038,  3.000,	0.598, # 20-30
    "typ_03", -2.755, 1.979,  99.215, 15.830, 0.775  # 40
  ) %>%  mutate( kvs  = kv_value(d, zvs)) 
 
  # Calculation characteristics
  
  base_data <- base_data %>% 
    mutate( dp = (p1 - p2),
            kv = kv(p1, p2, flow, temp)) %>% 
    mutate( zeta  = zeta_vaule(d, kv),
            sig_1 = sigma_1(p1, p2, elev, temp)) 
  
  data_analyse <- cylinder %>% 
    mutate(data = list(base_data)) %>% 
    unnest(data) %>% 
    mutate(kv_kvs = ifelse(kv > kvs, NA, kv/kvs), position = 0)
  
  for(i in c(1:length(data_analyse$kv_kvs))){
    if(is.na(data_analyse$kv_kvs[i])){
      data_analyse$position[i] <- NA
    } else {
      data_analyse$position[i] <- inv_LL3(data_analyse$kv_kvs[i], 
                                          data_analyse$kv.b[i],
                                          data_analyse$kv.d[i],
                                          data_analyse$kv.e[i])
    }
  }

```

  1. The flow should be a constant `r flow` $m^3/h$ (`r flow/3600` $m^3/s$).
  2. The control valve has a diameter of `r round(d*1000,0)` mm and is smaller than the diameters of the pipe upstream (`r round(D1*1000,0)` mm) and downstream (`r round(D2*1000,0)` mm)  of the valve.

Service Conditions:

  - Fluid : Water 
  - Water Temperature: `r temp` °C
  - Vapour pressure: `r round(vapour_pressure(temp),3)` $bar$
  - Altitude: `r elev` msal.
  - Atm. Pressure: `r round(atm_pressure(masl = elev),3)` $bar$
  - Diameter Pipe Upstream $D_1$: `r round(D1*1000,0)` mm  
  - Diameter Pipe Downstream $D_2$: `r round(D2*1000,0)` mm  
  - Diameter Valve $d$: `r round(d*1000,0)` mm  
  - Valve: Plunger Valve
  
The maximum mean and minimum pressures calculated and the valve (upstream and downstream) for the necessary constant flow can be seen in table  \@ref(tab:pressures-Example-02). 


```{r pressures-Example-02, echo=FALSE}
  base_data %>% 
    select(measurement, p1, p2, flow, dp) %>% 
    kbl(caption ="Pressures and flow data at the valve",
        col.names = c("Measurement", "$P_1$" , "$P_2$", "$Flow$", "$\\Delta{P}$")) %>% 
    add_header_above(c("", "$bar$", "$bar$", "$m^3/h$", "$bar$")) %>% 
    kable_classic( bootstrap_options = "striped", 
                   full_width = F, position = "left")
```

The different types of Control Characteristic Parameters for the valve can be seen in the table \@ref(tab:valvetyp-Example-02) and in the figures \@ref(fig:kvkvs-typ-01-Example-2),  \@ref(fig:kvkvs-typ-02-Example-2), and  \@ref(fig:kvkvs-typ-03-Example-2).

```{r valvetyp-Example-02, echo=FALSE}
  cylinder %>%
    select(typ, kvs, zvs, fls) %>% 
    kbl(caption ="Parameter of the Control Characteristic",
        col.names = c("$Typ$", "$K_{v_s}$", "$\\zeta_{v_s}$", "$F_{L_s}$"),
        digits = c(0, 0, 2, 2)) %>% 
    kable_classic( bootstrap_options = "striped", full_width = F, position = "left") 
    
```


```{r kvkvs-typ-01-Example-2, echo=FALSE, fig.cap="Inherent Valve Characteristics valve typ 01"}

  plot_kv_kvs(cylinder$kv.b[1], cylinder$kv.d[1], cylinder$kv.e[1], cylinder$typ[1]) 
  
```

```{r kvkvs-typ-02-Example-2, echo=FALSE, fig.cap="Inherent Valve Characteristics valve typ 02"}

  plot_kv_kvs(cylinder$kv.b[2], cylinder$kv.d[2], cylinder$kv.e[2], cylinder$typ[2]) 
  
```

```{r kvkvs-typ-03-Example-2, echo=FALSE, fig.cap="Inherent Valve Characteristics valve typ 03"}

  plot_kv_kvs(cylinder$kv.b[3], cylinder$kv.d[3], cylinder$kv.e[3], cylinder$typ[3]) 
  
```

### Step 2. Determine the equation constants.



### Step 3. Determine the piping geometry factor ($F_P$).

```{r valve-with-fittings2, echo=FALSE, fig.cap = 'Valve with fittings [@wagner2008]', fig.width = 10, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "valve_with_fittings.PNG")
  knitr::include_graphics(file_image)
```

according to equation \@ref(eq:Fp) :

$$
  F_{P} = \frac{1}{\sqrt{1+\frac{\sum{\zeta} \cdot \left(\frac{K_v}{d^2} \right)^2}{0.0016}}}
$$
Where \@ref(eq:sumZ)

$$
  \sum{\zeta} = (\zeta_{1} + \zeta_{2}) + (\zeta_{B_1} - \zeta_{B_2})
$$

and

Resistance coefficient of the valve in the inlet \@ref(eq:Z1): 
    $\zeta_{1} = 0.5 \cdot \left( 1 - \left( \frac{d}{D_1}\right)^2 \right)^2 =$ `r round(0.5*(1-(d/D1)^2)^2,4)`
  
Resistance coefficient of the valve in the outlet \@ref(eq:Z2): 
    $\zeta_{2} = \left( 1 - \left( \frac{d}{D_2}\right)^2 \right)^2 =$ `r round((1-(d/D2)^2)^2,4)`
  
Bernoulli pressure number in the valve inlet \@ref(eq:Zb1): 
    $\zeta_{B_1} = 1- \left( \frac{d}{D_1}  \right)^4 =$  `r round((1-(d/D1))^4,4)`
  
Bernoulli pressure number in the valve outlet \@ref(eq:Zb2): 
    $\zeta_{B_2} = 1- \left( \frac{d}{D_2}  \right)^4 =$ `r round((1-(d/D2))^4,4)`


