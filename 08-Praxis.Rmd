# How to Size a control valve

## Example 2:

   - Step 1. Specify the variables required  to size the valve.
   - Step 2. Determine the equation constants.
   - Step 3. Determine the piping geometry factor ($F_P$).
   - Step 4. Determine the pressure drop to use for sizing ($\Delta{P_{sizing}}).$
   - Step 5. Calculate the required flow coefficient ($K_v$).

### Step 1. Specify the variables required  to size the valve.

```{r include=FALSE}

  library(tidyverse)
  library(wcontrolvalve)

  temp <- 20.00   # °C
  elev <- 500.0   # m 
  p1   <- 30.00   # bar
  p2   <- 6.000   # bar
  flow <- 0.250   # m3/s
  d    <- 0.300   # m
  D1   <- 0.500   # m (DN Pipe Upstream)
  D2   <- 0.400   # m (DN Pipe Downstream)
  
  # kv curve SZ-40
  
  kv.b	<- -2.755
  kv.d	<-  1.979
  kv.e	<- 99.215
  zvs	  <- 15.830
  fl	  <-  0.775
```

  1. Water pressure must be managed from 30 bars to 6 bars.
  2. The control valve has a diameter of `r round(d*1000,0)` mm and is smaller than the diameters of the pipe upstream (`r round(D1*1000,0)` mm) and downstream (`r round(D2*1000,0)` mm)  of the valve.

Service Conditions:

  - Fluid : Water 
  - Water Temperature : `r temp` °C
  - Altitude: `r elev` msal.
  - $P_1 =$ `r p1` bar
  - $P_2 =$ `r p2` bar
  - $q =$ `r flow` LPS
  - Diameter Pipe Upstream $D_1$: `r round(D1*1000,0)` mm  
  - Diameter Pipe Downstream $D_2$: `r round(D2*1000,0)` mm  

Valve Design (first approx.):
  
  - Valve: Plunger Valve
  - Diameter Valve $d$: `r round(d*1000,0)` mm  
  - PN-40
  - Control Element : Cylinder SZ-40
  - Control Characteristic: Equal-Percentage Characteristic

### Step 2. Determine the equation constants.

  - 100% open 
    - Zeta Value $\zeta_{vs}$: `r zvs`
    - Flow coefficient: $K_{vs}$ : `r round(kv_value(d, zvs),0)` $m^3 / h$
    - liquid pressure recovery factor ${F_{L}}_{s}$ : `r fl`
  - Atmosphere Pressure : `r atm_pressure(masl = elev)` bar
  - Vapor Pressure : `r vapour_pressure(temp)*0.01` bar
  - Kinematic viscosity : `r kinematic_viscosity(temp)` $(m^2/s)*1e-6$

### Step 3. Determine the piping geometry factor ($F_P$).

```{r valve-with-fittings2, echo=FALSE, fig.cap = 'Valve with fittings [@wagner2008]', fig.width = 10, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "valve_with_fittings.PNG")
  knitr::include_graphics(file_image)
```

according to equation \@ref(eq:Fp) :

$$
  F_{P} = \frac{1}{\sqrt{1+\frac{\sum{\zeta} \cdot \left(\frac{K_v}{d^2} \right)^2}{0.0016}}}
$$
Where \@ref(eq:sumZ)

$$
  \sum{\zeta} = (\zeta_{1} + \zeta_{2}) + (\zeta_{B_1} - \zeta_{B_2})
$$

and

Resistance coefficient of the valve in the inlet \@ref(eq:Z1): 
    $\zeta_{1} = 0.5 \cdot \left( 1 - \left( \frac{d}{D_1}\right)^2 \right)^2 =$ `r round(0.5*(1-(d/D1)^2)^2,4)`
  
Resistance coefficient of the valve in the outlet \@ref(eq:Z2): 
    $\zeta_{2} = \left( 1 - \left( \frac{d}{D_2}\right)^2 \right)^2 =$ `r round((1-(d/D2)^2)^2,4)`
  
Bernoulli pressure number in the valve inlet \@ref(eq:Zb1): 
    $\zeta_{B_1} = 1- \left( \frac{d}{D_1}  \right)^4 =$  `r round((1-(d/D1))^4,4)`
  
Bernoulli pressure number in the valve outlet \@ref(eq:Zb2): 
    $\zeta_{B_2} = 1- \left( \frac{d}{D_2}  \right)^4 =$ `r round((1-(d/D2))^4,4)`

$\sum{\zeta} =$ `r round(0.5*(1-(d/D1)^2)^2 + (1-(d/D2)^2)^2 + (1-(d/D1))^4 - (1-(d/D2))^4, 4)`

$F_P =$ `r fp(kv_value(d, zvs), d, D1, D2)`
