# (PART) Praxis {-} 

# Use of flow rate equations for sizing valves

```{r echo=FALSE}

  # https://bookdown.org/yihui/rmarkdown-cookbook/diagrams.html
  # http://rich-iannone.github.io/DiagrammeR/index.html
  # https://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html

  # DiagrammeR::grViz(
  # 
  # "digraph {
  #   graph [layout = dot, rankdir = TB]
  #   
  #   #
  #   node [shape = oval]
  #   start [label = 'Start']
  #   
  #   # 
  #   node [shape = box]        
  #   rec1 [label = 'Select FL using valve typ and size' ]
  #   rec2 [label = 'Step 2. Write code']
  #   rec3 [label = 'Step 3. ???']
  #   rec4 [label = 'Step 4. PROFIT']
  # 
  #   # edge definitions with the node IDs
  #   start -> rec1 -> rec2 -> rec3 -> rec4
  # }",
  # 
  # height = 500)

```
  

## Example 1: Sizing a valve with constant flow, constant upstream, and constant downstream pressures.

   - Step 1. Specify the variables required  to size the valve.
   - Step 2. Read the values of the selected valve.
   - Step 3. Determine the flow coefficient $k_v$, the opening degree for the flow and $F_L$.
   
   - Step 4. Determine the pressure drop to use for sizing ($\Delta{P_{sizing}}).$
   - Step 5. Calculate the required flow coefficient ($K_v$).
   
   

### Step 1. Specify the variables required  to size the valve.

```{r include=FALSE}

  # Basic information
  temp <-  23.300   # °C
  elev <-   0.000   # m 
  p1   <-   5.700   # bar
  p2   <-   4.800   # bar
  flow <- 795.600   # m3/h
  d    <-   0.250   # m (DN of the valve)
  D1   <-   0.250   # m (DN Pipe Upstream)
  D2   <-   0.250   # m (DN Pipe Downstream)
  
  # Control Characteristics
  cylinder	<- "Equal Percentage"
  kv.b      <- -3.893
  kv.d	    <-  1.146
  kv.e      <- 61.038
  zvs	      <-  3.000
  fls	      <-  0.598
  
  # Calculation
  kvs       <- kv_value(d, zvs)
  kv_needed <- kv(p1, p2, flow, temp)
  kv_kvs    <- kv_needed/kvs*100
  position  <- inv_LL3(kv_needed/kvs, kv.b, kv.d, kv.e)
  fl        <- fl_function(position, kv.b, kv.d, kv.e, fls)
  zeta      <- zeta_vaule(d, kv_needed)
  sig_1     <- sigma_1(p1, p2, elev, temp)

  # Table for the plot
  df <- tibble( factor = c( "Kv", "Kv_Kvs", "Fl", "sigma_1", "zeta" ), 
                     y = c( kv_needed, kv_kvs, fl, sig_1, zeta ), 
                     x = c( position, position, position, position, position))
  
```

Service data : 
  1. Water pressure must be managed from 30 bars to 6 bars.
  2. The control valve has a diameter of `r round(d*1000,0)` mm and is smaller than the diameters of the pipe upstream (`r round(D1*1000,0)` mm) and downstream (`r round(D2*1000,0)` mm)  of the valve.


physical constants:
  
  - Fluid : Water 
  - Water Temperature :   `r temp` °C
  - Altitude:             `r elev` msal.
  - Atmosphere Pressure : `r atm_pressure(masl = elev)` bar
  - Vapor Pressure :      `r vapour_pressure(temp)*0.01` bar
  - Kinematic viscosity : `r kinematic_viscosity(temp)` $(m^2/s)*1e-6$

Service Conditions:

  - $P_1 =$                         `r p1` bar
  - $P_2 =$                         `r p2` bar
  - $\Delta{P}$                     `r p1 - p2` bar
  - $q =$                           `r flow` $m^3/h$ 
  - Diameter Pipe Upstream $D_1$:   `r round(D1*1000,0)` mm  
  - Diameter Pipe Downstream $D_2$: `r round(D2*1000,0)` mm  

Valve Design (first approx.):
  
  - Valve: Plunger Valve **VAG RIKO**
  - Diameter Valve $d$: `r round(d*1000,0)` mm  
  - PN-10
  - Control Element : Cylinder type `r cylinder`
  - Control Characteristic: 


### Step 2. Read the values of the selected Control Characteristic.
  
  - With the valve 100% open: 
    - Zeta Value $\zeta_{vs}$ :                       `r zvs`
    - Flow coefficient : $K_{vs}$ :                   `r round(kvs, 1)` $m^3 / h$
    - liquid pressure recovery factor ${F_{L}}_{s}$ : `r fls`


### Step 3. Calculate the required flow coefficient ($K_v$).

Using the function \@ref(eq:Kv-01):

$$
  K_v = q \cdot \sqrt{\frac {(\rho / \rho_{0})}{\Delta P}}
$$
the Required $K_v$ is `r round(kv_needed, 1)` $m^3 / h$ and the relative flow coefficient is $K_v / K_{vs}=$ `r round(kv_kvs,1)`%.

Entering the graph of $k_V / K_{VS}$ with the value of `r round(kv_kvs,1)` we find the position of the valve required for the flow of `r flow` $m^3/h$ and $\Delta{P}$ of `r p1 - p2` bar is `r round(position,2)`%.


```{r kv-kvs-Example-1, echo=FALSE, fig.cap="Inherent Valve Characteristics"}
  
  data_points <- df %>%  filter(factor == "Kv_Kvs")
  
  arrows_points <- tibble( x0 = 0,        y0 = kv_kvs,
                           x1 = position, y1 = kv_kvs,
                           x2 = position, y2 = 0)
  

  plot_kv_kvs(kv.b, kv.d, kv.e, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3) +
     geom_segment(data = arrows_points, 
                  aes(x = x0, y = y0, xend = x1, yend = y1),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))+
     geom_segment(data = arrows_points, 
                  aes(x = x1, y = y1, xend = x2, yend = y2),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))
  
```

Or it can be done directly with the $K_V =$ `r round(kv_needed,0)` $m^3/h$  value of on the $K_V$ graph.

```{r kv-Example-1, echo=FALSE, fig.cap="Flow coefficient"}
  
  data_points <- df %>%  filter(factor == "Kv")
  
  arrows_points <- tibble( x0 = 0,        y0 = kv_needed,
                           x1 = position, y1 = kv_needed,
                           x2 = position, y2 = 0)


  plot_kv(kv.b, kv.d, kv.e, d, zvs, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3)+
     geom_segment(data = arrows_points, 
                  aes(x = x0, y = y0, xend = x1, yend = y1),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))+
     geom_segment(data = arrows_points, 
                  aes(x = x1, y = y1, xend = x2, yend = y2),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))

```




```{r zv-Example-1, echo=FALSE, fig.cap="Zeta Value"}

  data_points <- df %>%  filter(factor == "zeta")

  plot_zv(kv.b, kv.d, kv.e, zvs, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3)
```


Liquid pressure recovery factor $F_L$: `r round(fl,3)`


```{r fl-Example-1, echo=FALSE, fig.cap="Liquid pressure Recovery Factor"}

  data_points <- df %>%  filter(factor == "Fl")

  plot_fl( kv.b, kv.d, kv.e, fls, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3)
```

```{r sigma-Example-1, echo=FALSE, fig.cap="Sigma Value"}

  data_points <- df %>%  filter(factor == "sigma_1")

  plot_sigma( kv.b, kv.d, kv.e, fls, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3)
```

### Step 3. Determine the pressure drop to use for sizing ($\Delta{P_{sizing}}).$

