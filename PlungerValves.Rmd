--- 
title: "Plunger Valves (UNDER CONSTRUCTION!!!)"
author: "Dr. Raúl Trujillo Álvarez"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib, Norms.bib]
biblio-style: apalike
link-citations: yes
description: "(UNDER CONSTRUCTION!!!) ....In this documentation, I want to clarify a systematic method for the selection of cylinder types, sizes, pressure ratings, and trim sizes of the plunger control valves."
---

```{r include=FALSE}
  library("tidyverse")
  library("here")
  library("scales")
  library("DiagrammeR")
  library("latex2exp")
  library("kableExtra")
  library("wcontrolvalve")
  library("gridExtra")
```


```{r include=FALSE}
# automatically create a bib database for R packages
  knitr::write_bib(c( .packages(), 
                      'bookdown', 'knitr', 'rmarkdown'), 'packages.bib')
```

<!--chapter:end:index.Rmd-->

# Preface {-}

# Introduction {#intro} 

Plunger valves are mainly used where volume flows or pressure have to be reduced and regulated with out vibrations, noises or big changes in the pipeline system.

The following advantages are obtained from the plunger valves [@r.heiler]:

  - universal use wide controllable range;
  - low cavitation coefficient, stable flow, low noise;
  - flow block is variable: optimum flow for every operating conditions;
  - low drive forces with pressure-relieving fix and mobile cylinder (pistons);

Plunger valves are control devices that cause pressure loss in pipeline systems by throttling to throttling to modify the flow or pressure so that the desired values are obtained, depending on the degree of opening adjustment.

To size a control valve, the following points must be considered [@r.heiler]:

  - The control valve must be permit the maximum flow under the lowest-possible differential pressure.
  - The flow range (maximum, median and minimum) relative to the degree of opening of the control valve must be such that the regulation circuit is stable.
  - In the entire control range (maximum, median and minimum), there should be no occurrence of cavitation.
  - The pipeline systems are planned and installed, bearing in mind future requirements, and it is often forgotten that control valves designed for this end capacities are oversized at the start of the operation but not for the future requirements. Reducing the size of the control valve means generating additional problems and costs in the future of system operation.

One of the most uncomfortable things that can a hydraulic design Ingenieur happens is a valve that he/she chose for six months ago deteriorate and having to listen to the unflattering comments made by the maintenance department. The most common causes of premature valve failure are:

  - cavitation damage.
  - cavitation and flashing of water (shock flow).
  - erosion of the valve.
  - vibration, (unstable flow pattern with liquids).
  - corrosion.
  - leakages (valve/actuator may be cycling).

To avoid in any way, the following design criteria must be met [@baumann2009]:

  - Criteria for valve selection :
    - Is the valve appropriately sized? 
    - Does the valve have a low dead band, sometimes confused with hysteresis? 
    - Will it be able to operate without a positioner (also a cost factor)? 
    - Does it have adequate rangeability? 
    - Is the flow characteristic acceptable (installed characteristic)? 
    - How is its dynamic performance (frequency response, time constant)? 

  - Installation and affects on the environment:
    - Is the face-to-face such that it can be replaced with another make? 
    - How heavy is it? 
    - Are supports needed? 
    - Is it too tall?
    - Is it going to be noisy under the given flow conditions? 
    - Is there energy supply (in the case of electric actuators)? 
    - Can it withstand the corrosive effects of fluid and the environment? 
    - Would the valve be cavitating under the given flow conditions? 
    - If outdoors, can the valve and actuator stand extreme weather conditions? 

  - Maintainability and long-term cost:
    - Is it easy to repair? 
    - What are the costs of spare parts? 
    - Can the actuator tolerate a vibrating environment? 
    - How is the actuator protected from corrosion? 
    - Is the packings field-replaceable? 
    - Is the control cylinders (fix and mobile) are field-replaceable? 
    - Is the actuator able to diagnose the valve? 
    
Another essential point to consider is the information available. Sizing the flow to the fifth place after the decimal point is all well and good, but only if you know the right process conditions [@baumann2009]: 

  - First of all, the valve should be sized to control the maximum flow rate under the lowest-possible differential pressure. But what is maximum flow this exactly? 
  - How about emergency conditions? 
  - On the other hand, should the valve fail full open, would the resultant flow be more than the downstream pipe or valve could handle? 
  - what is the correct inlet pressure? 
  - What are the variations in inlet pressure?
  - Can you use the head pressure of the pump from the manufacturer’s published curve? (If you do, use the head pressure corresponding to the maximum flow the valve has to pass, and don’t ignore the static head at the pump’s location.) 
  - How about line losses? 

My experience is that all these questions will be answered in a vague form from the design people. They don’t know either and have to rely on the input from other departments. The result is usually guesswork with ample safety factors thrown in. 

Only after reviewing these criteria and deciding on the proper valve type should the subject of cost be considered

## Structure of the document {-}

This document focuses on the sizing of plunger control valves in the transportation and distribution of drinking and raw water. 

It is recommended that readers have a basic understanding of hydraulic. Part I Theory introduces the fundamental usage and syntax, which should be sufficient to get most readers started in sizing a control valve.  This part provides an overview of the basics hydraulic functions and is recommended reading for any new users of this document. 

In part II praxis, I will concentrate on the development of examples, based on the information published by the different manufacturers of plunger valves. 

Reading these documents does not exclude knowledge of the different European, American, and regional standards regarding control valve sizing. It is also necessary to have access to the norms, technical literature, and information of the producer about control valve sizing to delve into the different concepts.

This document is a compilation of existing information in the European, American standards, books and articles by different authors and articles by different manufacturers of valves. I have tried to cite all of the above sources, but I apologize in advance if this is not correct at any time.

## Normative references {#norms}

The following referenced documents are indispensable for the application of this document. For dated references, only the edition cited applies. For undated references, the latest version of the referenced material (including any amendments) applies.

  - **EN 736-1:1995**, Valves — Terminology — Part 1: Definition of types of valves
  - **EN 736-3:2008**, Valves — Terminology — Part 3: Definition of terms
  - **EN 1057**, Copper and copper alloys — Seamless, round copper tubes for water and gas in sanitary and heating applications
  - **EN 24006:1993**, Measurement of fluid flow in closed conduits — Vocabulary and symbols (ISO 4006:1991)
  - **EN ISO 6708:1995**, Pipework components — Definition and selection of DN (nominal size) (ISO 6708:1995)
  - **ISO 7-1:1994**, Pipe threads where pressure-tight joints are made on the threads — Part 1: Dimensions, tolerances and designation
  - **ISO 7194:2008**, Measurement of fluid flow in closed conduits — Velocity-area methods of flow measurement in swirling or asymmetric flow conditions in circular ducts by means of current-meters or Pitot static tubes

**Other International Normative references**

  - **ISA Guide**     Control Valves, Practical Guides for Measurement and Control.
  - **ISA S20.50**    Specification Forms for Process Measurement and Control Instruments, Primary Elements and Control Valves.
  - **ISA S75.01**    Flow Equations for Sizing Control Valves.
  - **ISA S75.05**    Control Valve Terminology.
  - **ISA S75.11**    Inherent Flow Characteristic and Rangeability of Control Valves.
  - **ISA SP75.17**   Control Valve Aerodynamic Noise Prediction.
  - **ISA RP75.23**   Considerations for Evaluating Control Valve Cavitation.
  - **ANSI/ISA-75.02-1996**, Control Valve Capacity Test Procedures.
  - **ANSI/ISA-75.05.01-2000 (R2005)**, Control Valve Terminology.
  - **IEC 60534-1:2005**, Industrial-process control valves – Part 1: Control valve terminology and general considerations.
  - **IEC 60534-2-3:1997**, Industrial-process control valves – Part 2-3: Flow capacity – Test procedures.


## Nomenclature {#nomenclature}

| Symbol        | Description                                          | Units (notes) |
|:--------------|:-----------------------------------------------------|:--------------|
| $d$           | Valve inlet diameter                                 |mm|
| $D$           | Internal diameter of the pipe                        |mm|
| $F_d$         | Valve style modifier                                 |dimensionless|
| $F_F$         | Liquid critical pressure ratio factor, dimensionless |dimensionless|
| $F_L$         | Liquid pressure recovery factor of a valve without attached fittings|dimensionless|
| $F_{LP}$      | Product of the liquid pressure recovery factor of a valve with attached fittings (no symbol has been identified) and the piping geometry factor|dimensionless|
| $F_P$         | Piping geometry factor, dimensionless                |dimensionless|
| $F_R$         | Reynolds number factor, dimensionless                |dimensionless|
| $K_c$         | coefficient of constant cavitation                   |dimensionless|
| $g$           | Local acceleration of gravity                        |$m^2 / s$|
| $K_v$         | Valve flow coefficient                               |$m^3/h$|
| $p_1$         | Upstream **_absolute_** static pressure, measured two nominal pipe diameters upstream of valve-fitting assembly |$bar$ absolute|
| $p_2$         | Downstream **_absolute_** static pressure, measured six nominal pipe diameters downstream of valve-fitting assembly |$bar$ absolute|
| $P_c$         | Absolute thermodynamic critical pressure             |$bar$ absolute|
| $P_v$         | Absolute vapor pressure of the liquid at inlet temperature |$bar$ absolute|
| $P_{vc}$      | Apparent absolute pressure at vena contracta         |$bar$ absolute|
| $\Delta{P}$   | pressure differential between upstream and downstream pressures $(p_1 - p_2)$ | $bar$|
| $\Delta{P_{max}}$ | maximum allowable pressure differential for control valve sizing purposes for in-compressible fluids | $bar$|
| $q$           | Volumetric flow rate                                 |$m^3/h$|
| $q_{max}$     | Maximum flow rate (choked flow conditions) at a given upstream condition |$m^3/h$|
| $Re_v$        | Valve Reynolds number                                |dimensionless|
| $T_1$         | Upstream temperature (inlet absolute temperature)    |$K$|
| $X$           | ratio of pressure differential to inlet absolute pressure| dimensionless|
| $X_{cr}$      | ratio of pressure differential to inlet absolute pressure in critical conditions $(\Delta{p} / p_1)_{cr}$ | dimensionless |
| $X_{FZ}$      | coefficient of incipient cavitation|dimensionless|
| $\gamma_{1} \; (Gamma)$ | Specific weight, upstream conditions       ||
| $\mu \; (mu)$           | dynamic viscosity, absolute                |$Pa \; s$|
| $\rho_{0} \; (rho)$ | specific mass of water at 15.5 °C i.e. 999 $kg/m^3$   |$kg/m^3$|
| $\rho_{1} \; (rho)$ | specific mass of fluid at $p_1$ and $T_1$  |$kg/m^3$|
| $\rho_{0} / \rho_{1}$ | ratio of specific mass of fluid in upstream condition to specific mass of water at 15.5 °C  |dimensionless|
| $\upsilon$| kinematic viscosity $(\upsilon= \mu / \rho )$|$m^2/s$|
| $\epsilon$ | Surface roughness often shortened to roughness, is a component of surface texture. |$mm$|
| $\epsilon / D$ | The pipe's relative roughness, where ε is the pipe's effective roughness height and D the pipe (inside) diameter. |  dimensionless|
| $f$| stands for the Darcy friction factor. Its value depends on the flow's Reynolds number $Re$ and on the pipe's relative roughness $\epsilon / d$.| dimensionless |












<!--chapter:end:01-intro.Rmd-->


# (PART) Theory {-} 

# Hydraulic Basics {#HydraulicBasics}

## Equations 

 - If the Area for pipes is equal to: 

\begin{equation} 
  A = \frac{\pi \cdot d^2}{4}
  (\#eq:pipe-area)
\end{equation}
  
  - And the Velocity ist:
  
\begin{equation} 
  V = \frac{Q}{A} = \frac{4 \cdot q}{\pi \cdot d^2} 
  (\#eq:velocity)
\end{equation}

  - therefore it is:

\begin{equation}
  \frac{V^2}{2g} = \frac{8 \cdot q^2}{g \cdot \pi^{2} \cdot d^4} 
  (\#eq:energy-velocity)
\end{equation}

## Energy Head

  - **Energy Head:** 
  
\begin{equation}
  H = \frac{v^2}{2 \cdot g} + \frac{p}{\rho \cdot g} + z
  (\#eq:energy-heady)
\end{equation}

  - **Bernoulli energy equation:**  
  
\begin{equation}
  \frac{v_1^2}{2 \cdot g} + \frac{p_1}{\rho \cdot g} + z_1 = \frac{v_2^2}{2 \cdot g} + \frac{p_2}{\rho \cdot g} + z_2 + \Delta h_{ls}
  (\#eq:bernoulli)
\end{equation}

  - **Hydraulic losses:** 
  
\begin{equation}
  \Delta h_{ls} = H_1 - H_2 = h_{pl} + h_{ml}
  (\#eq:hydraulic-losse)
\end{equation}
  
## Hydraulic Head losses

Reference: [@2020wa]

  - **Pipe friction losses (_Darcy-Weisbach equation_):** 
  
\begin{equation}
  h_{pl} =  \left( f \cdot \frac{l}{d} \right) \cdot \left( \frac{v^2}{2 \cdot g} \right)
  (\#eq:darcy-weisbach)
\end{equation}
  
  - **Minor losses:** 
  
\begin{equation}
  h_{ml} = \zeta_{l} \cdot \left( \frac{v^2}{2 \cdot g} \right)
  (\#eq:minor-losses)
\end{equation}
    
 - $\zeta_{l}$ **means (local) loss coefficient:**  is dimensionless, it is not correlated in the literature with the _Reynolds number_ $(\mathit{Re})$ and roughness ratio but rather simply with the raw size of the pipe. Almost all data are reported for turbulent-flow conditions.
 
 - The Darcy friction factor, $f$, is usually selected from a chart known as the _Moody diagram_. The _Moody diagram_ is a family of curves that relate the friction factor, $f$, to _Reynolds number_, $Re$, and the relative roughness of a pipe, $\varepsilon/d$.

## Darcy Friction Factor Formula

Reference : [@2020w]

   - **the friction factor $f$ depends on Reynolds number and relativa roughness:** 

\begin{equation}
   f= \varphi (Re, \varepsilon/d)
  (\#eq:friction-factor)
\end{equation}
  
   - **The Colebrook equation is the most widely used equation to solve the Darcy friction factor:**

\begin{equation}
   \frac{1}{\sqrt{f}} =-2.0 \; log \left( \frac{\varepsilon/d}{3.7} + \frac{2.51}{Re \sqrt{f}} \right)
  (\#eq:Colebrook)
\end{equation}

   - **_Reynolds number_ ($Re$): is the Principal parameter used to specify the type of flow regime.** 

\begin{equation}
   Re = \frac{v \cdot d}{\nu} =  \frac{4 \cdot q}{\pi \cdot d \cdot \nu}
  (\#eq:reynolds-number)
\end{equation}
    
    
    
## Calculation of the friction factor 

  - **Equation of Swammee and Jain (1976):** 

\begin{equation}
  \frac{1}{\sqrt{f}} = -2 \cdot log \left( \frac{\varepsilon}{3.7} + \frac{5.74}{Re^{0.9}} \right)
  (\#eq:swammee)
\end{equation}

  - **Equation of Haaland (1983):**  

\begin{equation}
  \frac{1}{\sqrt{f}} = -1.8 \cdot log \left( \left( \frac{\varepsilon}{3.7}\right)^{1.11} + \frac{6.9}{Re} \right)
  (\#eq:haaland)
\end{equation}


  - **Equation of Zigrang and Sylvester (1982):** 

\begin{equation}
  \frac{1}{\sqrt{f}} = -2 \cdot log \left[ \frac{\varepsilon}{3.7} - \frac{5.02}{Re}  \cdot log \left( \varepsilon - \frac{5.02}{Re}  \cdot log \left(\frac{\varepsilon}{3.7}+ \frac{13}{Re} \right) \right) \right]
  (\#eq:zigrang)
\end{equation}
  

## Roughness coefficient $\varepsilon$ of the pipe in mm


```{r roughnessTab, fig.cap="Roughness coefficient in milimeter.", echo=FALSE}

# read data 

  roughness_pipes <- here::here("data", "roughness_pipes.csv") %>% 
      read_csv( col_types = list( col_character(), col_character(),
                col_logical(), col_logical(), col_logical(),
                col_double(), col_double()))
  
  DT::datatable(roughness_pipes)
```


<!--chapter:end:02-HydraulicBasics.Rmd-->

# Valves Hidraulic {#HydraulicValves}

## The _Flow coefficient_ $k_{v}$ 

Flow factor $k_{v}$  combines the effects of all flow restrictions in the valve into a single number.
$k_{v}$ represents the flow of water with temperature ranging between $5°C$ and $30°C$ through a valve in cubic meters per hour with a pressure drop of $1 bar$ [@wagner2008].

Do you need for the calculation of the valve flow factor ($k_{v}$) : 

 - operating pressure differential; 
 - flow rate for your application; 
 - Density of the fluid; 
 - and in some circumstances, temperature. 

## _Flow coefficient_ $k_{v}$ and _Loss Coefficient_ $\zeta_{v}$ 

The valve flow coefficient $k_v$ is defined as the number of cubic meters per hour of 5°C to 30°C water that will flow through a control valve at a specified position of the control valve (travel) $h$ with a differential pressure ($\Delta p=p_1-p_2$) of 105 Pa (1bar) across it.

The standard conditions referred to in definitions of flow coefficients ($K_v$) are the following:

  - flow in turbulent condition;
  - no cavitation and vaporisation phenomena;
  - valve diameter equal to pipe diameter;
  - static pressure drop measured between upstream and downstream pressure taps;
  - straight pipe lengths upstream and downstream the valve;
  - Newtonian fluid.

According to this European Standard, the flow rate characteristic parameter of a valve is the flow coefficient, $K_v$. The equation, the quantity subject to measurement and input quantities are the following [@wagner2008].

\begin{equation} 
  K_v = q \cdot \sqrt{\frac {(\rho / \rho_{0})}{\Delta P}} 
  (\#eq:Kv-01)
\end{equation} 

 - $\Delta P$ : operating pressure differential; 
 - $q$ : flow rate for your application; 
 - $\rho_{0}$ : Density of Liquids; 
 - $d$ Nominal size 
 - $K_v$: Flow $m^3/hour$ at $\Delta P = 1 \, bar$    
 - and in some circumstances, temperature $T$. 


\begin{equation} 
  K_{v} = q \cdot \sqrt{\frac{1}{\Delta P }} = \frac{q}{\sqrt{\Delta P}}
  (\#eq:Kv-02)
\end{equation} 

 - If the $\zeta$ value of the valve is : 

\begin{equation}
  \zeta_{v} = {\frac{1}{626.3} \cdot  \bigg( {\frac{d^2}{{K_v}}}} \bigg)^2
  (\#eq:zeta-01)
\end{equation} 

  - The $K_{v}$ in function of the $\zeta_{v}$ is:
  
\begin{equation}
  K_v = \frac{d^2}{\sqrt{626.3}} \cdot \frac{1}{\sqrt{\zeta}}
  (\#eq:Kv-03)  
\end{equation} 

## The flow basic characteristic curve (inherent flow characteristic).
The characteristic of a control valve is defined as the flow rate depending on the valve's position. The control valve generates a change in the flow by changing the active area of control piston $A$, assuming a constant differential pressure $\Delta p$ and a constant density $\rho$.

If the characteristic curve is determined under unit conditions, referred to below as the _"basic characteristic curve"_. The valve characteristic curve is a function of valve position (degree of opening) $vp$ in percentage. The basic characteristic of the control valves ($K_v/K_{vs}$) depend of the position of the valve ($pv$).

$$
  K_v/K_{vs} = f(x, (b, d, e))
$$

In this document, the characteristic curves are approximated by means of the  [Dose-Response Analysis](https://en.wikipedia.org/wiki/Dose%E2%80%93response_relationship) $(dcr)$.  Dose-response models are regression models where the independent variable referred to as the dose, or in our case, the opening degree of a valve. In contrast, the dependent variable is generally referred to as response or effect. 

The full specification of a statistical dose-response (regression) model involves specifying how the mean is described by a parametric function of dose (valve position) as well as assumptions about the distribution of the response ($K_v/K_{vs}$).

A large number of more or less well-known model functions are building in $drc$.  These models are parameterized using a unified structure with the coefficients: 

  - $b$ denoting the steepness of the dose-response curve, 
  - $d$ is the lower and upper asymptotes or limits of the response, and, 
  - for some models, $e$ the effective dose. 

By far the log-logistic models are the most used dose-response models. The three-parameter log-logistic model corresponds to the function:

\begin{equation}
  f(x, (b, d, e)) =  \frac{d}{1 + \exp( b \cdot (\log{x} - \log{e}))}
  (\#eq:Dose-response-model)  
\end{equation} 

## Zeta value in function of the $K_v/K_{vs}$ characteristic curve

If \@ref(eq:zeta-01) and \@ref(eq:Kv-03) for $K_{vs}$ then:


\begin{equation}
  \zeta_{v} = {\frac{1}{626.3} \cdot  \bigg( {\frac{d^2}{{K_v}}}} \bigg)^2 \: ; \: 
  K_{v} = \frac{d^2}{\sqrt{626.3}} \cdot \frac{1}{\sqrt{\zeta_{v}}}
\end{equation} 

if

\begin{equation}
  K_{v} = f(x, (b, d, e)) \cdot K_{vs} \\ K_{v} = f(x, (b, d, e)) \cdot  \frac{d^2}{\sqrt{626.3}} \cdot     \frac{1}{\sqrt{\zeta_{vs}}}
\end{equation} 

then

\begin{equation}
  \frac{1}{K_{v}^2} = \frac{\zeta_{vs}}{[f(x, (b, d, e))]^2} \cdot \frac{626.3}{d^4} \\
  {\frac{1}{626.3} \cdot  \bigg( {\frac{d^2}{{K_v}}}} \bigg)^2 = \frac{\zeta_{vs}}{[f(vp\%)]^2}
\end{equation} 

then:

\begin{equation}
  \zeta_{v} = \frac{\zeta_{vs}}{[f(x, (b, d, e))]^2}
  (\#eq:zeta-02)
\end{equation} 

<!--chapter:end:03-HydraulicValves.Rmd-->

# Sizing equations for incompressible fluids (flow of nonvaporizing liquid)

Sizing equations allow us to calculate a value of the flow coefficient starting from different operating conditions (the type of fluid, pressure drop, flow rate, type of flow, and installation) and making them mutually comparable as well as with the standard one. The equations outlined in this chapter are by the standards IEC 60534-2-1  and IEC 60534-2-3 [@ansi/isa2007].

Choked flow is a limiting, or maximum, flow rate. With fixed inlet (upstream) conditions, it manifests by the failure of decreasing downstream pressure to increase the flow rate.

Choking occurs as a result of the vaporization of the liquid. The vaporization occurs when the pressure within the valve falls below the vapor pressure of the fluid. Choked flow will be accompanied by either cavitation or flashing. If the downstream pressure is higher than the vapor pressure of the liquid, cavitation occurs. If the downstream pressure is equal to or less than the vapor pressure of the fluid, flashing occurs.This relationship between flow rate and pressure drop for a typical valve is shown in figure \@ref(fig:Flow-rate-diagram) [@ansi/isa1985a].

In general actual flow rate, $q_m$ of a incompressible fluid through a valve is plotted in figure  \@ref(fig:Flow-rate-diagram) versus the square root of the pressure differential $\sqrt{\Delta{P}}$ under constant upstream conditions.

```{r Flow-rate-diagram, echo=FALSE, fig.cap = 'Liquid flow rate versus pressure drop for a typical valve (constant upstream pressure and vapor pressure) [@ansi/isa1985a]', fig.width = 8, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "flow_rate_versus_pressure_drop.png")
  knitr::include_graphics(file_image)
```

## Maximum Flow without fitings

The maximum rate at which flow will pass through a control valve at choked flow [in $m^3/h$] conditions be calculated as follows [@wagner2008]:

\begin{equation} 
  q_{max} = K_v \cdot F_{L} \cdot F_R \cdot \sqrt{p_1 - F_F \cdot p_v}
  (\#eq:Qmax-Without)
\end{equation} 

Where: 

  - $F_R$ is the Reynolds number factor 
  - $F_L$ is the Liquid pressure recovery factors.
  - $F_F$ is the Liquid critical pressure ratio factor 

\begin{equation} 
  \Delta P_{max} = {F_L}^2 \cdot (P_1 - F_F \cdot p_v) 
  (\#eq:Pmax-Without)
\end{equation} 

## Maximum Flow with flow limitation and with fitting

[@wagner2008]

```{r Effect-of-Fittings, echo=FALSE, fig.cap = 'Effect of fittings (reducer) on the flow capacity [@ansi/isa1985a]', fig.width = 8, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "valve_with_fittings3.png")
  knitr::include_graphics(file_image)
```

\begin{equation} 
  q_{max} = K_v \cdot F_{LP} \cdot F_R \cdot \sqrt{P_1 - F_F \cdot p_v}
  (\#eq:Qmax-With)
\end{equation} 

\begin{equation} 
  \Delta P_{max} = {\left(\frac{F_{LP}}{F_P}\right)}^2 \cdot (P_1 - F_F \cdot p_v) 
  (\#eq:Pmax-With)
\end{equation} 

Where: 

  - $F_R$ is the Reynolds number factor 
  - $F_P$ is the The piping geometry factor.
  - $F_{LP}$ is the Liquid pressure recovery factor for the valve with reducers. 
  - $F_F$ is the Liquid critical pressure ratio factor 

## Liquid pressure recovery factor $F_{L}$

```{definition, name="pressure recovery factor"}
A number used to describe the ratio between the pressure recovery after the vena contracta and the pressure drop at the vena contracta. It is a measure of the amount of pressure recovered between the vena contracta and the valve outlet. This number will be high (0.9) for a globe style valve with a torturous follow path and lower (0.8 to 0.6) for a rotary style valve with a streamlined flow path. On most rotary products the $F_L$ factor will vary with the degree of opening of the valve closure member [@ansi/isa1983].
```

It is also important to understand that $F_L$ is not a cavitation parameter. It is a choked flow parameter and its only use is to determine the theoretical choked flow point based on the assumption that the choked flow point, $\sqrt{\Delta P_{choked}}$, is the intersection of the two straight dashed lines shown in Figures in red and green. Using $F_L$ as a cavitation parameter is almost sure to result in unacceptable levels of cavitation damage.


## Piping geometry factor $F_{p}$

```{definition, name="Piping geometry factor"}
The piping geometry factor $F_{p}$ accounts for fittings attached to either the valve inlet or the outlet that disturb the flow to the extent that valve capacity is affected. $F_P$ is actually the ratio of the flow coefficient of a valve with attached fittings to the flow coefficient ($K_v$) of a valve installed in a straight pipe of the same size as the valve [@ansi/isa1985a].
```

```{r valve-with-fittings, echo=FALSE, fig.cap = 'Valve with fittings [@wagner2008]', fig.width = 10, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "valve_with_fittings.PNG")
  knitr::include_graphics(file_image)
```


$F_P$, the factor for the pipe geometry, takes into account the influence of the fittings that are attached directly to the inlet and/or outlet of a control valve (figure \@ref(fig:valve-with-fittings)). The $F_P$ factor is the ratio of the flow rate of a control valve with fittings to the flow rate that would result if the control valve were tested without fittings under identical conditions [@wagner2008] and [@ansi/isa2007].

\begin{equation} 
    F_{P} = \frac{1}{\sqrt{1+\frac{\sum{\zeta} \cdot \left(\frac{K_v}{d^2} \right)^2}{0.0016}}}
    = \left( \frac{\sum{\zeta} \cdot K_v^2}{0.0016 \cdot d^4} + 1 \right)^{-1/2}
(\#eq:Fp)
\end{equation} 


In this equation, the factor $\sum \zeta$ is the algebraic sum of all effective resistance coefficients of all fittings that are attached to the control valve. This does not include the drag coefficient of the control valve itself.

\begin{equation} 
  \sum{\zeta} = (\zeta_{1} + \zeta_{2}) + (\zeta_{B_1} - \zeta_{B_2})
  (\#eq:sumZ)
\end{equation} 

Where:

  - $\zeta_{1}$ resistance coefficient of the valve in the inlet
  - $\zeta_{2}$ resistance coefficient of the valve in the outlet
  - $\zeta_{B_1}$  Bernoulli pressure number in the valve inlet
  - $\zeta_{B_2}$  Bernoulli pressure number in the valve outlet

If the diameters of the inlet and outlet fittings are the same, $\zeta_{B_1}$ and $\zeta_{B_1}$ become equal and fall out of the equation. In cases where the pipe diameters in front of and behind the control valve are different, the $\zeta_{coefficients}$ are calculated as follows:

\begin{equation} 
  \zeta_{B_1} = 1- \left( \frac{d}{D_1}  \right)^4
  (\#eq:Zb1)
\end{equation} 


\begin{equation} 
  \zeta_{B_2} = 1- \left( \frac{d}{D_2}  \right)^4
  (\#eq:Zb2)
\end{equation} 

If the inlet and outlet ports are short, commercially available concentric reducers and diffusers, then the coefficients $\zeta_1$ and $\zeta_2$ can be calculated roughly as follows:

\begin{equation} 
  \zeta_1 = 0.5 \cdot \left( 1 - \left( \frac{d}{D_1}\right)^2 \right)^2
  (\#eq:Z1)
\end{equation} 

\begin{equation}
  \zeta_2 = \left( 1 - \left( \frac{d}{D_2}\right)^2 \right)^2
  (\#eq:Z2)
\end{equation} 

Then for inlet reduction and outlet expansion with the same pipe size:

\begin{equation}
  \sum \zeta = \zeta_1 + \zeta_2 = 1.5 \cdot \left( 1 - \left( \frac{d}{D_1}\right)^2 \right)^2
  (\#eq:sumZ2)
\end{equation} 


## Combined liquid pressure recovery factor $F_{LP}$

When a valve is installed with reducers or other attached fittings, the liquid pressure recovery of the valve-fitting combination is not the same as that for the valve alone.  For calculations involving choked flow, it is convenient to treat the piping geometry factor $F_p$ and the $F_L$ factor for the valve-fitting combination as a single factor. The factor $F_{LP}$ is determined in the same way as FL, with laboratory test results (For maximum accuracy, F LP must be determined by using the test procedures specified in [@ansi/isa1996}).

If the permissible deviation is to remain ≤ 5%, $F_{LP}$ must be determined through tests. If estimates are allowed, sufficient accuracy can be achieved by using the following equation [@wagner2008] and [@ansi/isa2007]:

\begin{equation} 
  F_{LP} = \frac{F_L}{\sqrt{1 + F_L \cdot \frac{\sum{\zeta} \cdot \left(\frac{K_v}{d^2} \right)^2}{0.0016}}} 
  = F_L \cdot \left(\frac{\sum{\zeta} \cdot F_L^2 \cdot K_v^2}{0.0016 \cdot d^4} + 1 \right)^{-1/2}
(\#eq:Flp)
\end{equation} 

## Reynolds number factor $F_{R}$

```{definition, name="Reynolds number factor"}
The Reynolds number factor $F_R$ is required when non-turbulent flow conditions are established through a control valve because of a low pressure differential, a high viscosity, a very small flow coefficient, or a combination thereof.
```

$F_{R}$, the correction factor for the influence of the Reynolds number, is to be used for non-turbulent flow in the control valve because there is either a low differential pressure or a highly viscous liquid or a very low flow coefficient or a combination thereof. The $F_{R}$ factor is determined by dividing the flow coefficient for non-turbulent flow conditions by the flow coefficient determined under the same installation conditions under turbulent circumstances. If no test results are available, $F_{R}$ can be determined from the curve according to figure  \@ref(fig:Reynolds-Valve-Sizing)  by using a valve Reynolds number that is calculated from the following equation [@wagner2008]:

\begin{equation} 
  Re_v = \frac{7.07 \cdot 10^4 \cdot F_d \cdot Q}{\upsilon \cdot \sqrt{F_p \cdot F_L \cdot K_v}} \cdot 
  \left( \frac{{F_P}^2 \cdot  {F_L}^2 {K_v}^2   }{0.0016 \cdot D^4} + 1 \right)
  (\#eq:reynolds-valve)
\end{equation}

with: $\upsilon$ in $[mm^2 / s ]$

Values for $F_d$:
  
  - 0.7 for control valves with two parallel flow paths; 
  - 1.0 for valves with a V-shaped throttle cross-section, normal single-seat, and ball valves. 

```{r Reynolds-Valve-Sizing, echo=FALSE, fig.cap = 'Reynolds number factor for valve sizing [@ansi/isa1985a]', fig.width = 8, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "ReynoldsValveSizing.png")
  knitr::include_graphics(file_image)
```

## $F_F$ is the Liquid critical pressure ratio factor

```{definition, name="Liquid critical pressure ratio factor"}
$F_F$ is the liquid critical pressure ratio factor. This factor is the ratio of the apparent vena contracta pressure at choked flow conditions to the vapor pressure of the liquid at inlet temperature. At vapor pressures near zero, this factor is $0.96$.
```

Values of $F_F$ may be determined approximated from the following equation:

\begin{equation} 
  F_F = 0.96 - 0.28 \cdot \sqrt{p_v / p_c}
  (\#eq:critical-pressure)
\end{equation}

Where: $p_c$ is the thermodynamic critical pressure. For water, this value is $p_c = 221.2 \cdot bar$ and $p_v$ vapor pressure of the liquid.

## $F_L$ and $F_{LP}$ as limit for the choked flow.

| Syntax      | Description |
| ----------- | ----------- |
| $\Delta{P_{max}} = {F_L}^2 \cdot (P_1 - F_F \cdot p_v)$|${\left(\frac{1}{F_{L}}\right)}^2 = \frac{(P_1 - F_F \cdot p_v)}{\Delta{P_{max}}}$|
| $\Delta P_{max} = {\left(\frac{F_{LP}}{F_P}\right)}^2 \cdot (P_1 - F_F \cdot p_v)$|${\left(\frac{F_P}{F_{LP}}\right)}^2= \frac{(P_1 - F_F \cdot p_v)}{\Delta{P_{max}}}$|

Here it is essential to understand that being $\sqrt{F_L}$ or $\sqrt{(F_{LP}/{F_P})}$ determines the limit of the choked flow; this value of $\Delta{P_{max}}$ is the maximum differential pressure acceptable for the valve in the current opening position, so:

$$
  \frac{(P_1 - F_F \cdot p_v)}{\Delta{P_{max}}}  \leq \frac{(P_1 - p_v)}{\Delta{P}}
$$

##  $F_L$ as function of the $K_v / K{vs}$




$$
   \frac{1}{F_{L}^2} = \frac{(P_1 - F_F \cdot p_v)}{\Delta{P_{max}}} = \frac{(P_2 - F_F \cdot p_v)}{\Delta{P_{max}}} + 1
$$
If we define $\sigma_1$ that:

$$
   \frac{1}{F_{L}^2} - 1 = \frac{(P_2 - F_F \cdot p_v)}{\Delta{P_{max}}} = \sigma_{1}
$$

The maximum value of sigma $\sigma_{1_S}$ (for the fully open valve) where $F_{L_S}$ is the Liquid pressure recovery factor by 100% open the valve, would be:


$$
  \sigma_{1_S} = \frac{1}{F_{L_S}^2} -1  
$$
The Sigma $\sigma_{1_S}$ maximum changes proportionally to the value of $K_V/K_{VS}$ therefore:

$$
  \sigma_{1_S} * (K_V / K_{VS}) = \frac{1}{F_{L}^2} -1  
$$

$$
  {F_{L}^2} = \frac{1}{\sigma_{s} * (K_V / K_{VS}) +1 }  
$$

$$
  {F_{L}^2} = \frac{1}{ \left( \frac{1}{F_{L_S}^2} -1 \right)  * (K_V / K_{VS}) +1 }  
$$


\begin{equation} 
  F_{L} = \sqrt{ \frac{1}{ \left( \frac{1}{F_{L_S}^2} -1 \right)  * (K_V / K_{VS}) + 1} }
  (\#eq:Fl-function)
\end{equation}

## Flow Rate Diagram


```{r Flow-rate-diagram2, echo=FALSE, fig.cap = "Flow rate diagram through a control valve versus downstream pressure under constant upstream conditions.", fig.width = 8, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "Flow_Rate_Diagram.png")
  knitr::include_graphics(file_image)
```

Usually the beginning of cavitation is identified by the coefficient of incipient cavitation $X_{FZ}$ :

The coefficient of constant cavitation $K_C$ identifies where the cavitation begins to appear in water flow through the control valve with such an intensity that, under constant upstream conditions, the flow rate deviation from the linearity versus $\sqrt{\Delta{P}}$ exceeds **2%**. A simple calculation rule uses the formula:


\begin{equation} 
  K_C = 0.80 \cdot {F_L}^2
  (\#eq:Kc-function)
\end{equation}

The coefficient of incipient cavitation $X_{FZ}$ identifies the beginning of cavitation. 

The $X_{FZ}$ coefficient can be determined by a test using sound level meters or accelerometers connected to the pipe and relating noise and vibration increase with the beginning of bubble formation [**IEC 60534-8-2** _“Laboratory measurement of the noise generated by a liquid flow through a control valve”_]. 


<!--chapter:end:04-EquationsIncompressibleFluids.Rmd-->

# Quantifying the Cavitation Potential of the valve 

Its effect on the system varies with valve type, size, operating pressure, and details of the piping installation. To include cavitation in the design process is necessary to determine if cavitation will it's, evaluate its intensity, characterize the flow conditions, and estimate its effect on the system and environment. Possible consequences include noise, vibration, erosion damage, and a decrease in performance.

In the case of control valves it is conventional to describe the application in terms of a single parameter and then to compare this parameter to different limits of operation for a given control element.

To characterize the flow conditions corresponding to a selected level of cavitation requires defining a cavitation index derived from dimensional analysis. The process involves determining the fluid properties, geometric characteristics, and fluid parameters that influence the cavitation process. The main variables affecting the cavitation process are: 

  1. the geometric configuration of the device,
  2. absolute pressure in the cavitating region, 
  3. the critical pressure, generally assumed to be the liquid vapor pressure and 
  4. velocity or pressure drop

The cavitation index sigma $\sigma$ is a form of another dimensionless parameter.Sigma is constant for either _SI_ or _US_ Customary units as long as the same units of pressure are used throughout the equations for the parameter.

This index (σ) is the ratio of fluid forces trying to prevent cavitation (the system or service pressure) to the forces trying to cause cavitation (the pressure drop). The smaller the value of the cavitation index for a flow system, the more likely or the more severe cavitation will be.

The force suppressing cavitation is proportional to the magnitude of the average pressure relative to absolute vapor pressure i.e. $(P-P_r)$. The force causing cavitation is proportional to the velocity head  $V^2/2g$ or to the pressure drop across the valve $\Delta P$. The resulting cavitation parameter sigma can be expressed as [@tullis1993]:

\begin{equation} 
  \sigma = \frac{P_1-P_v}{\Delta P_{net}}
  (\#eq:sigma-value-00a)
\end{equation} 

in which: 

  - $P_1$ is the absolute pressure just upstream from the valve $(P_l = P_u + P_b)$, 
  - $P_u$ is _the gauge pressure just upstream from the valve_, 
  - $P_b$ is _the atmospheric or barometric pressure_, 
  - $P_v$ is _the absolute vapor pressure_ and 
  - $\Delta P_{net}$ _the net pressure drop across the valve_.

The minimum value of sigma ($\sigma$) is $1.0$ since the maximum $\Delta P_{net}$  across the valve is $(P_1 - P_v)$.

For valves and other devices that create a pressure drop, the cavitation parameter can be defined in several ways. The reference pressure in the numerator of the equation of sigma equation \@ref(eq:sigma-value-00a) can be either the upstream or the downstream pressure. Both have been used, and there are valid reasons supporting either choice.

Using the downstream pressure $P_2$, the equation becomes:

\begin{equation}
  \sigma_{1} = \frac{P_2-P_v}{\Delta P_{net}}
  (\#eq:sigma-value-01)
\end{equation} 

In which $P_2$ is the absolute downstream pressure ($P_2 = P_d + P_b$), where $P_d = P_u - \Delta P_{net}$ and $P_b$ is the barometric pressure. 

This is the form originally preferred because the _downstream pressure is the pressure closer to the zone where the cavitation occurs_. Therefore, the downstream pressure more directly influences the cavitation. However, it is more convenient to use the upstream pressure for most applications, and the two sigma values differ by a constant value of $1.0$. The following simple equation directly relates the equation:

\begin{equation}
  \sigma = \sigma_{1} + 1
  (\#eq:sigma-value-00b)
\end{equation} 


For cavitation caused by surface roughness, an isolated roughness, an offset in the boundary or by any device for which it is not possible or convenient to evaluate a pressure differential, the velocity head can be used in place of $\Delta{P}$ in Equation of $\sigma$. The resulting equation is:

\begin{equation}
  \sigma_{2} = \frac{P_1-P_v}{(V^2/2g)}
  (\#eq:sigma-value-02)
\end{equation}

Some authors have chosen to use the reciprocal of Equation for $\sigma$ and have defined the cavitation index as $K_c$ instead of $\sigma$. The equation defining $K_c$ is:

\begin{equation}
  K_c = \frac{1}{\sigma_{1}} = \frac{\Delta P_{net}}{(P_2-P_v)} 
  (\#eq:cavitation-index)
\end{equation}

If you want to add a factor of safety to the cavitation parameter $\sigma$ \@ref(eq:sigma-value-00a) that includes the possible cavitation caused by any device for which it is not possible or convenient to evaluate a pressure differential close to the control valve, then:

\begin{equation} 
  \begin{split}
    \frac{1}{\sigma_{}} + \frac{1}{\sigma_{2}} 
      & =  \frac{\Delta P_{net}}{(P_1-P_v)} + \frac{(V^2/2g)}{(P_1-P_v)} \\
      & = \frac{\Delta P_{net} + (V^2/2g)}{(P_1-P_v)}
  \end{split}
\end{equation} 


So:

\begin{equation}
  \sigma_{3} = \frac{(P_1-P_v)}{\Delta P_{net} + (V^2/2g)}
  (\#eq:igma-value-03)
\end{equation}


## Evaluating the Cavitation Limits of the valve

Cavitation causes noise, pressure fluctuations, vibrations, erosion damage, and in advanced stages, can reduce the valve's capacity. The acceptable cavitation level for a valve in a given system varies with valve type, valve function, details of the piping layout and duration of the operation. 

It is necessary to identify and provide experimental data for several levels of cavitation intensity to have adequate information for analysis and design.  There are defined six different cavitation design limits. The methods used to determine each limit experimentally are described, and suggestions are given as to when each limit might be appropriate. These limits are:

  1. Incipient cavitation $\sigma_{i}$ 
  2. Critical (or constant) cavitation $\sigma_{c}$
  3. Incipient damage $\sigma_{i_d}$
  4. Incipient choking $\sigma_{i_{ch}}$ (or Kc)
  5. Choked flow $\sigma_{ch}$
  6. Maximum noise and vibration level $\sigma_{max}$
  
```{definition, name="cavitation"}
A two-stage process associated with the flow of liquids. The first stage involves the formation of vapor bubbles in the flow stream as a result of the local static pressure in the flow stream dropping below the liquid vapor pressure. The second stage of the process is the subsequent collapse or implosion of the vapor cavities back to the liquid state when the local static pressure again becomes greater than the fluid vapor pressure [@ansi/isa1995].

```{definition, name="cavitation coefficient"}
A characteristic number for σ (e.g., $\sigma_{i}$, $\sigma_{c}$, $\sigma_{mv}$, $\sigma_{id}$, $\sigma_{ch}$), determined for a given valve, valve opening, and pressure conditions, which corresponds to the numerical value of the cavitation index at which the levels of incipient cavitation, constant cavitation, maximum vibration cavitation, incipient damage, and choking cavitation occur [@ansi/isa1995].
```

```{definition, name="cavitation index"}
The value for the operating service conditions of a valve, expressed as $\sigma_{}$ and numerically equal to $(p_1 - p_v )/(p_1 - p_2 )$ [@ansi/isa1995].
```

```{definition, name="cavitation level"}
The degree to which cavitation is occurring, i.e., incipient, constant, incipient damage, choking, or maximum vibration. Levels can be determined by testing for vibration, pitting or metal loss, and changes in valve capacity $(k_v)$ [@ansi/isa1995].
```

```{definition, name="choking cavitation"}
A limiting flow condition in which vapor formation is enough to limit the rate of flow through the valve to some maximum value. Further increases in flow rate through the valve are only possible by increasing the valve inlet pressure, because reducing downstream pressure will no longer increase flow rate [@ansi/isa1995].
```

```{definition, name="flashing"}
A flow condition in which vapor pockets formed inside a valve persist downstream of the valve because the valve outlet pressure is at or below the fluid vapor pressure [@ansi/isa1995].

```

```{definition, name="duty cycle"}
The ratio of the amount of time a valve spends performing one particular function to the valve's total installed time period. It may be expressed as a percentage of total time (service time vs. installed time) [@ansi/isa1995].

```

SIGMA Values:

1. Incipient cavitation. ($\sigma_{i}$):
   • Onset of cavitation
   • Detect using high frequency vibration measurement
   • Very local phenomenon
   • Transient: random “ticks” sound
   • Low level cavitation: usually not damaging
   • Occurs prior to loss of capacity
2. Constant cavitation ($\sigma_{c}$):
   • More regular cavitation events
   • Lower frequency sound and vibration sensed: “rumbling” sound
   • Some damage to surfaces may occur: dependent upon valve and trim styles, and materials.
3. Maximum Cavitation ($\sigma_{mv}$):
   • Highest vibration amplitude: sounds like “marbles” or “gravel”
   • Vigorous, large scale cavitation
   • Predicted by steady flow pressure distribution ( = $F_L$ )
   • Very high damage potential
4. Manufacturer’s Recommended Limit ($\sigma_{mr}$)


<!--chapter:end:05-Cavitation.Rmd-->

# Inherent and installed flow characteristics

First: After the valve is installed into a piping system, the above flow characteristics are only applicable when:

  - the pressure drop upstream and downstream remains constant with flow changes.
  - there are be no onset of flashing or cavitation at certain flow conditions; and
  - the valve isn't installed between reducer.
  
As you can see from the above, this is ideal conditions that will be only possible in the manufacturer's flow lab.

So, we have to deal with the “installed flow characteristic.” The installed flow characteristic is the relationship of flowing quantity to valve travel, accounting for the difference in pressure drop between the maximum and minimum flow, and the distortion that the reducer head losses create in the inherent valve flow characteristic. This installed characteristic is what finally affects the controller stability [@baumann2009].

In another form, The relationship between the valve stem position and the flow rate through a control valve is the characteristic of the valve.

An equal percentage flow characteristic is a non-linear curve whose slope increases as the valve opens; A linear flow characteristic is a straight line. 

Control valves manipulate the rate of liquid flow through them by altering the open area through which the liquid passes. 

Linear valves increase open area linearly with valve travel, while equal percentage valves progressively open more area with the valve travel.




<!--chapter:end:06-FlowCharacteristics.Rmd-->

# (PART) Praxis {-}

# Example 1. 

The goal of this exercise is to verify the operating conditions of a preset control valve. The sizing of a valve without accessories will be controlled (valve diameter equal to the diameter of the pipes), constant flow, constant pressures both upstream and downstream.

The steps to follow are those:

   - Step 1. Specify the variables required for the verification of the valve size.
   - Step 2. Read the values of the selected valve.
   - Step 3. Determine the flow coefficient $k_v$, the opening degree for the flow and $F_L$.
   - Step 4. calculate the value of sigma ($\sigma$) and its boundaries.
  
## Step 1. Specify the variables required for the verification of the valve size.

```{r include=FALSE}

  # Basic information
  temp <-  23.300   # °C
  elev <-   0.000   # m 
  p1   <-   5.700   # bar
  p2   <-   4.800   # bar
  flow <- 795.600   # m3/h
  d    <-   0.250   # m (DN of the valve)
  D1   <-   0.250   # m (DN Pipe Upstream)
  D2   <-   0.250   # m (DN Pipe Downstream)
  
  # Cylinder parameter/Characteristics
  cylinder	<- "Equal Percentage"
  kv.b      <- -3.893
  kv.d	    <-  1.146
  kv.e      <- 61.038
  zvs	      <-  3.000
  fls	      <-  0.598
  
  # Calculation
  kvs       <- kv_value(d, zvs)
  kv_needed <- kv(p1, p2, flow, temp)
  kv_kvs    <- kv_needed/kvs*100
  position  <- inv_LL3(kv_needed/kvs, kv.b, kv.d, kv.e)
  fl        <- fl_function(position, kv.b, kv.d, kv.e, fls)
  zeta      <- zeta_vaule(d, kv_needed)
  sig_1     <- sigma_1(p1, p2, elev, temp)

  Sig_i     <- Sigma_i(position,  kv.b,  kv.d,  kv.e, fls) # Incipient Cavitation
  Sig_c     <- Sigma_c(position,  kv.b,  kv.d,  kv.e, fls) # Constant Cavitation
  Sig_mv    <- Sigma_mv(position,  kv.b,  kv.d,  kv.e, fls) #  Maximum Vibration Cavitation


  # Table for the plot
  df_base <- tibble( factor = c( "Kv", "Kv_Kvs", "Fl", "zeta",
                            "sig_1", "Sig_i", "Sig_c", "Sig_mv"), 
                     y = c( kv_needed, kv_kvs, fl, zeta, 
                            sig_1, Sig_i, Sig_c, Sig_mv ), 
                     x = c( position, position, position, position,
                            position, position, position, position))
  
```

Service data : 
  1. Water pressure must be managed from 30 bars to 6 bars.
  2. The control valve has a diameter of `r round(d*1000,0)` mm and is smaller than the diameters of the pipe upstream (`r round(D1*1000,0)` mm) and downstream (`r round(D2*1000,0)` mm)  of the valve.


physical constants:
  
  - Fluid : Water 
  - Water Temperature :   `r temp` °C
  - Altitude:             `r elev` msal.
  - Atmosphere Pressure : `r atm_pressure(masl = elev)` bar
  - Vapor Pressure :      `r vapour_pressure(temp)*0.01` bar
  - Kinematic viscosity : `r scientific(kinematic_viscosity(temp))` $(mm^2/s)$

Service Conditions:

  - $P_1 =$                         `r p1` bar
  - $P_2 =$                         `r p2` bar
  - $\Delta{P}$                     `r p1 - p2` bar
  - $q =$                           `r (flow)` $m^3/h$ 
  - Diameter Pipe Upstream $D_1$:   `r round(D1*1000,0)` mm  
  - Diameter Pipe Downstream $D_2$: `r round(D2*1000,0)` mm  

Valve Design (first approx.):
  
  - Valve: Plunger Valve
  - Diameter Valve $d$: `r round(d*1000,0)` mm  
  - PN-10
  - Control Element : Cylinder type `r cylinder`
  - Control Characteristic: 


## Step 2. Read the values of the selected Control Characteristic.

check the values of the preselected valve (values supplied by the valve producer). 
  
  - With the valve 100% open: 
    - Zeta Value $\zeta_{vs}$ :                       `r comma(zvs)`
    - Flow coefficient : $K_{vs}$ :                   `r comma(kvs)` $m^3/h$
    - liquid pressure recovery factor ${F_{L}}_{s}$ : `r fls`


## Step 3. Calculate the required flow coefficient ($K_v$).

Using the function \@ref(eq:Kv-01):

$$
  K_v = q \cdot \sqrt{\frac {(\rho / \rho_{0})}{\Delta P}}
$$
the Required $K_v$ is `r comma(kv_needed)` $m^3/h$ and the relative flow coefficient is $K_v/K_{vs}=$ `r percent(kv_kvs/100)`.

Entering the graph of $k_V/K_{VS}$ with the value of `r percent(kv_kvs/100)` we find the position of the valve required for the flow of `r comma(flow)` $m^3/h$ and $\Delta{P}$ of `r p1 - p2` bar is `r percent(position/100)`.


```{r kv-kvs-Example-1, echo=FALSE, fig.cap="Inherent Valve Characteristics"}
  
  data_points <- df_base %>%  filter(factor == "Kv_Kvs")
  
  arrows_points <- tibble( x0 = 0,        y0 = kv_kvs,
                           x1 = position, y1 = kv_kvs,
                           x2 = position, y2 = 0)
  
  plot_kv_kvs(kv.b, kv.d, kv.e, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3) +
     geom_segment(data = arrows_points, 
                  aes(x = x0, y = y0, xend = x1, yend = y1),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))+
     geom_segment(data = arrows_points, 
                  aes(x = x1, y = y1, xend = x2, yend = y2),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))
  
```

Or it can be done directly with the $K_V =$ `r comma(kv_needed)` $m^3/h$  value of on the $K_V$ graph.

```{r kv-Example-1, echo=FALSE, fig.cap="Flow coefficient"}
  
  data_points <- df_base %>%  filter(factor == "Kv")
  
  arrows_points <- tibble( x0 = 0,        y0 = kv_needed,
                           x1 = position, y1 = kv_needed,
                           x2 = position, y2 = 0)


  plot_kv(kv.b, kv.d, kv.e, d, zvs, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3) +
     geom_segment(data = arrows_points, 
                  aes(x = x0, y = y0, xend = x1, yend = y1),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))+
     geom_segment(data = arrows_points, 
                  aes(x = x1, y = y1, xend = x2, yend = y2),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))

```


Knowing that the valve position is `r round(position,2)`%, it is possible to read the Zeta Value $\zeta_{v}$ and the Liquid Pressure Recovery Factor ${F_L}$.:

  - $\zeta_{v}=$ `r comma(zeta) `
  - ${F_L}=$ `r round(fl,3) `
  - Reynolds Number of the valve `r comma(Reynolds_valve(flow, kv_needed, d*1000, D1*1000, D2*1000, temp, fl, 1)) `


```{r zv-Example-1, echo=FALSE, fig.cap="Zeta"}

  data_points <- df_base %>%  filter(factor == "zeta")

  arrows_points <- tibble( x0 = position, y0 = 0,
                           x1 = position, y1 = zeta,
                           x2 = 0,        y2 = zeta)

  plot_zv(kv.b, kv.d, kv.e, zvs, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3)  +
     geom_segment(data = arrows_points, 
                  aes(x = x0, y = y0, xend = x1, yend = y1),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))+
     geom_segment(data = arrows_points, 
                  aes(x = x1, y = y1, xend = x2, yend = y2),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))
```


```{r fl-Example-1, echo=FALSE, fig.cap="Liquid pressure Recovery Factor"}

  data_points <- df_base %>%  filter(factor == "Fl")

  arrows_points <- tibble( x0 = position, y0 = 0,
                           x1 = position, y1 = fl,
                           x2 = 0,        y2 = fl)

  plot_fl( kv.b, kv.d, kv.e, fls, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "red", size = 3) +
     geom_segment(data = arrows_points, 
                  aes(x = x0, y = y0, xend = x1, yend = y1),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))+
     geom_segment(data = arrows_points, 
                  aes(x = x1, y = y1, xend = x2, yend = y2),
                  arrow = arrow(length = unit(0.03, "npc"), type = "closed"))
```

## Step 4. calculate the value of sigma ($\sigma$) and its boundaries.

Using the function \@ref(eq:sigma-value-01):

$$
  \sigma_{1} = \frac{P_2-P_v}{\Delta P_{net}}
$$

  - Sigma value ($\sigma_{1}$): `r round(sig_1,3)`

  - Incipient Cavitation ($\sigma_{i}$): `r round(Sig_i,3)`
  
  - Constant Cavitation ($\sigma_{c}$):  `r round(Sig_c,3)`

  - Maximum Vibration Cavitation ($\sigma_{mv}$): `r round(Sig_mv,3)`



```{r sigma-Example-1, echo=FALSE, warning=FALSE, fig.cap="Sigma"}
  
  # https://sebastiansauer.github.io/dplyr_filter/
  
  data_points <- df_base %>%  
    filter(factor %in% c("sig_1", "Sig_i", "Sig_c", "Sig_mv"))

  arrows_points <- tibble( x0 = 0,         y0 = sig_1,
                           x1 = position,  y1 = sig_1,
                           x2 = 0,         y2 = Sig_i,
                           x3 = position,  y3 = Sig_i,
                           x4 = 0,         y4 = Sig_c,
                           x5 = position,  y5 = Sig_c,
                           x6 = 0,         y6 = Sig_mv,
                           x7 = position,  y7 = Sig_mv,
                           x8 = position,  y8 = 0)

  # Line type : "solid", "dashed", "dotted", "dotdash", "longdash", "twodash")
  
  lty <- "dotted"
  
  plot_sigma( kv.b, kv.d, kv.e, fls, cylinder) +
    geom_point( data = data_points, aes( y = y, x = x ), colour = "black", size = 2) +
     geom_segment(data = arrows_points, aes(x = x0, y = y0, xend = x1, yend = y1), linetype = lty) +
     geom_segment(data = arrows_points, aes(x = x1, y = y1, xend = x8, yend = y8), linetype = lty) +
     geom_segment(data = arrows_points, aes(x = x2, y = y2, xend = x3, yend = y3), linetype = lty) +
     geom_segment(data = arrows_points, aes(x = x4, y = y4, xend = x5, yend = y5), linetype = lty) +
     geom_segment(data = arrows_points, aes(x = x6, y = y6, xend = x7, yend = y7), linetype = lty)
    
  
```

## Step 5. Conclusions.

It is good design practice to have a Safety Factor (Surcharge factor) for the maximum expected Kv. It is recommended that $K_{v}$ be less than or equal to 75% of the $K_{vs}$. In this exercise, it is `r percent(kv_needed/kvs)` which is `r ifelse(percent(kv_needed/kvs)<0.75, "not acceptable.", "ok.")`

The characteristic number $\sigma_{1}$ determined for the given valve, valve opening, and pressure conditions must be greater than the corresponding numerical values of the cavitation index at which the incipient cavitation ($\sigma_{i}$), constant cavitation $\sigma_{c}$, and maximum vibration levels ($\sigma_{mv}$) occur.

with a $\sigma_{1}$ of `r round(sig_1,3)`, the valve is in the range of **`r cavtation_regime(position,  kv.b,  kv.d,  kv.e, fls, sig_1)`**



<!--chapter:end:07-Praxis.Rmd-->

# Example 2. 

The objective of this exercise is to select between three possible types of control valves (the same valve but different types of cylinders) the most suitable for the operation of the system.

The conditions are as follows:

  - the diameter of the valve is smaller than the diameter of the pipes;
  -  the system requires a constant flow,
  - the pressures upstream and downstream of the valve vary during the operation of the system;
  - Initially, only three operational points will be evaluated.
  
The steps to follow are those:

   - Step 1. Specify the variables required  to size the valve.
   - Step 2. Determine the equation constants.
   - Step 3. Determine the piping geometry factor ($F_P$).
   - Step 4. Determine the pressure drop to use for sizing ($\Delta{P_{sizing}}).$
   - Step 5. Calculate the required flow coefficient ($K_v$).

## Step 1. Specify the variables required  to size the valve.

```{r include=FALSE}

  temp <- 15.00   # °C
  elev <- 2700    # m 
  flow <- 9396    # m3/h
  dn   <- 1000    # mm
  d1   <- 1400    # mm (DN Pipe Upstream)
  d2   <- 1200    # mm (DN Pipe Downstream)
  
  # base_data Pressures (bar)
  base_data <- tribble(
    ~measurement,  ~p1,   ~p2, ~flow,
    "Min.",      1.720, 0.614,  9396,
    "Mean",      1.410, 0.684,  9396,
    "Max.",      1.370, 1.009,  9396
  ) 
  
  # Cylinder parameter/Characteristics
  
  cylinder <- tribble(
    ~typ,      ~kv.b, ~kv.d,   ~kv.e,   ~zvs,  ~fls,
    "typ_01", -2.393,	1.389,  67.422,	 1.780,	0.617, # 0
    "typ_02", -3.893,	1.146,  61.038,  3.000,	0.598, # 20-30
    "typ_03", -2.755, 1.979,  99.215, 15.830, 0.775  # 40
  ) 
  
  cylinder <- cylinder %>% 
    mutate( kvs  = kv_value(dn, zvs)) %>% 
    mutate( fps  = fp(kvs, dn, d1, d2)) %>% 
    mutate( flps = flp(kvs, fls, dn, d1, d2)) %>% 
    mutate( flps_fps = flps/fps) %>% 
    select( typ, kv.b, kv.d, kv.e, kvs, zvs,  fls, fps, flps, flps_fps)
  
  # Calculation characteristics
  
  base_data <- base_data %>% 
    mutate( dp = (p1 - p2),
            kv = kv(p1, p2, flow, temp)) %>% 
    mutate( zeta  = zeta_vaule(dn, kv),
            sig_1 = sigma_1(p1, p2, elev, temp)) 
  
  data_analyse <- cylinder %>% 
    mutate(data = list(base_data)) %>% 
    unnest(data) %>% 
    mutate(kv_kvs = ifelse(kv > kvs, NA, kv/kvs), position = 0)
  
  for(i in c(1:length(data_analyse$kv_kvs))){
    if(is.na(data_analyse$kv_kvs[i])){
      data_analyse$position[i] <- NA
    } else {
      data_analyse$position[i] <- inv_LL3(data_analyse$kv_kvs[i], 
                                          data_analyse$kv.b[i],
                                          data_analyse$kv.d[i],
                                          data_analyse$kv.e[i])
    }
  }
  
  data_analyse <- data_analyse %>% 
    mutate( flp_fp = ifelse(kv > kvs, NA, fl_function( position, kv.b, kv.d, kv.e, flps_fps)),
            Sig_i  = ifelse(kv > kvs, NA, Sigma_i( position, kv.b, kv.d, kv.e, flps_fps)),  # Incipient Cavitation
            Sig_c  = ifelse(kv > kvs, NA, Sigma_c( position, kv.b, kv.d, kv.e, flps_fps)),  # Constant Cavitation
            Sig_mv = ifelse(kv > kvs, NA, Sigma_mv( position, kv.b, kv.d, kv.e, flps_fps)), #  Maximum Vibration Cavitation
            regime = ifelse(kv > kvs, NA, cavtation_regime(position, kv.b, kv.d, kv.e, flps_fps, sig_1)))
  

  data_analyse <- data_analyse %>%
    group_by(typ, kv.b, kv.d, kv.e, zvs, kvs, fls, fps, flps, flps_fps) %>% 
    nest()

  
```

  1. The flow should be a constant `r flow` $m^3/h$ (`r flow/3600` $m^3/s$).
  2. The control valve has a diameter of `r round(d*1000,0)` mm and is smaller than the diameters of the pipe upstream (`r round(d1*1000,0)` mm) and downstream (`r round(d2*1000,0)` mm)  of the valve.

Service Conditions:

  - Fluid : Water 
  - Water Temperature: `r temp` °C
  - Vapour pressure: `r round(vapour_pressure(temp),3)` $bar$
  - Altitude: `r elev` msal.
  - Atm. Pressure: `r round(atm_pressure(masl = elev),3)` $bar$
  - Diameter Pipe Upstream $D_1$: `r round(d1*1000,0)` mm  
  - Diameter Pipe Downstream $D_2$: `r round(d2*1000,0)` mm  
  - Diameter Valve $d$: `r round(d*1000,0)` mm  
  - Valve: Plunger Valve
  
The maximum mean and minimum pressures calculated and the valve (upstream and downstream) for the necessary constant flow can be seen in table  \@ref(tab:pressures-Example-02). 


```{r pressures-Example-02, echo=FALSE}
  base_data %>% 
    select(measurement, p1, p2, flow, dp) %>% 
    kbl(caption ="Pressures and flow data at the valve",
        col.names = c("Measu.", "$P_1$" , "$P_2$", "$Flow$", "$\\Delta{P}$")) %>% 
    add_header_above(c("", "$bar$", "$bar$", "$m^3/h$", "$bar$")) %>% 
    kable_classic( bootstrap_options = "striped", 
                   full_width = F, position = "left")
```

The different types of Control Characteristic Parameters for the valve can be seen in the table \@ref(tab:valvetyp-Example-02) and in the figures \@ref(fig:kvkvs-typ-01-Example-2),  \@ref(fig:kvkvs-typ-02-Example-2), and  \@ref(fig:kvkvs-typ-03-Example-2).

```{r valvetyp-Example-02, echo=FALSE}
  cylinder %>%
    select(typ, kvs, zvs, fls) %>% 
    kbl(caption ="Parameter of the Control Characteristic",
        col.names = c("$Typ$", "$K_{v_s}$", "$\\zeta_{v_s}$", "$F_{L_s}$"),
        digits = c(0, 0, 2, 2)) %>% 
    kable_classic( bootstrap_options = "striped", full_width = F, position = "left") 
    
```


```{r kvkvs-typ-01-Example-2, echo=FALSE, fig.cap="Valve Characteristics valve typ 01"}

  i <- 1
  p1 <- plot_kv(cylinder$kv.b[i], cylinder$kv.d[i], cylinder$kv.e[i], d, cylinder$zvs[i], cylinder$typ[i]) 
  p2 <- plot_zv(cylinder$kv.b[i], cylinder$kv.d[i], cylinder$kv.e[i], cylinder$zvs[i], cylinder$typ[i])
  grid.arrange(p1, p2, nrow = 1)
  
```

```{r kvkvs-typ-02-Example-2, echo=FALSE, fig.cap="Valve Characteristics valve typ 02"}


  i <- 2
  p1 <- plot_kv(cylinder$kv.b[i], cylinder$kv.d[i], cylinder$kv.e[i], d, cylinder$zvs[i], cylinder$typ[i]) 
  p2 <- plot_zv(cylinder$kv.b[i], cylinder$kv.d[i], cylinder$kv.e[i], cylinder$zvs[i], cylinder$typ[i])
  grid.arrange(p1, p2, nrow = 1)
  
```

```{r kvkvs-typ-03-Example-2, echo=FALSE, fig.cap="Valve Characteristics valve typ 03"}


  i <- 3
  p1 <- plot_kv(cylinder$kv.b[i], cylinder$kv.d[i], cylinder$kv.e[i], d, cylinder$zvs[i], cylinder$typ[i]) 
  p2 <- plot_zv(cylinder$kv.b[i], cylinder$kv.d[i], cylinder$kv.e[i], cylinder$zvs[i], cylinder$typ[i])
  grid.arrange(p1, p2, nrow = 1)

```


## Step 3. Determine the piping geometry factor ($F_{P_s}$) and the combined liquid pressure recovery factor ($F_{LP_s}$).

```{r valve-with-fittings2, echo=FALSE, fig.cap = 'Valve with fittings [@wagner2008]', fig.width = 10, fig.asp = 0.7, fig.align = "center"}
  file_image <- here::here("image", "valve_with_fittings.PNG")
  knitr::include_graphics(file_image)
```

according to equation \@ref(eq:Fp) :

$$
  F_{P} = \left( \frac{\sum{\zeta} \cdot K_v^2}{0.0016 \cdot d^4} + 1 \right)^{-1/2}
$$
and equation \@ref(eq:Flp) :

$$
  F_{LP} = F_L \cdot \left(\frac{\sum{\zeta} \cdot F_L^2 \cdot K_v^2}{0.0016 \cdot d^4} + 1 \right)^{-1/2}
$$

Where the factor $\sum{\zeta}$ \@ref(eq:sumZ) is the algebraic sum of the effective velocity head coefficients of all fittings attached to but not including the valve. For instance,

$$
  \sum{\zeta} = (\zeta_{1} + \zeta_{2}) + (\zeta_{B_1} - \zeta_{B_2})
$$

where

Resistance coefficient of the valve in the inlet \@ref(eq:Z1): 
    $\zeta_{1} = 0.5 \cdot \left( 1 - \left( \frac{d}{D_1}\right)^2 \right)^2 =$ `r 0.5*(1-(d/d1)^2)^2`
  
Resistance coefficient of the valve in the outlet \@ref(eq:Z2): 
    $\zeta_{2} = \left( 1 - \left( \frac{d}{D_2}\right)^2 \right)^2 =$ `r (1-(d/d2)^2)^2`
  
Bernoulli pressure number in the valve inlet \@ref(eq:Zb1): 
    $\zeta_{B_1} = 1- \left( \frac{d}{D_1}  \right)^4 =$  `r 1-(d/d1)^4`
  
Bernoulli pressure number in the valve outlet \@ref(eq:Zb2): 
    $\zeta_{B_2} = 1- \left( \frac{d}{D_2}  \right)^4 =$ `r 1-(d/d2)^4`

$\sum{\zeta} =$ `r resistance_coefficient(d, d1, d2)`


so:

```{r flp-Example-02, echo=FALSE}
  data_analyse %>% ungroup() %>% 
    select(typ, kvs, zvs, fls, fps, flps, flps_fps) %>% 
    kbl(caption ="Piping geometry factor and the combined liquid pressure recovery factor",
        col.names = c("$Typ$", "$K_{v_s}$", "$\\zeta_{v_s}$", "$F_{L_s}$", "$F_{P_s}$", "$F_{LP_s}$", "$F_{LP_s}/F_{P_s}$"),
        digits = c(0, 0, 3, 3, 3, 3, 3)) %>% 
    kable_classic( bootstrap_options = "striped", full_width = F, position = "left") 
    
```

## Step 4. Calculation of needes $K_v$, $Z_v$, Sigma ($\sigma$), valve position, and  $k_v/k_{vs}$

### With the valve  `r data_analyse$typ[1]`

```{r positions1-Example-02, echo=FALSE}
  data_analyse$data[[1]] %>%  
    mutate( flow = scales::comma(flow),
            kv = scales::comma(kv),
            sig_1 = round(sig_1,2),
            kv_kvs   = scales::percent(kv_kvs), 
            position = scales::percent(position/100)) %>% 
    select(measurement, p1, p2, flow, dp, kv, sig_1, kv_kvs, position) %>% 
    kbl(caption ="Pressures and flow data at the valve",
        col.names = c("Measu.", "$P_1$" , "$P_2$", "$Flow$", "$\\Delta{P}$", "$K_v$", "$\\sigma_{1}$", "$K_v/K_{vs}$", "Opening")) %>% 
    add_header_above(c("", "$bar$", "$bar$", "$m^3/h$", "$bar$", "$m^3/h$", "--", "%", "%")) %>% 
    kable_classic( bootstrap_options = "striped", 
                   full_width = F, position = "left") %>%
    footnote( symbol = c("NA values in $K_v/K_{vs}$, this means that the required flow capacity is not available.") )
```



```{r kv-kvs1-Example-2, echo=FALSE, fig.cap="Inherent Characteristic of the valve", warning=TRUE}

  i <- 1
  
  data_points <- data_analyse$data[[i]] %>% 
    select( position, kv_kvs) %>% 
    mutate( kv_kvs = kv_kvs * 100) %>% 
    rename( x = position, y = kv_kvs )
  
  plot_kv_kvs(  data_analyse[i,]$kv.b, data_analyse[i,]$kv.d, 
                data_analyse[i,]$kv.e, data_analyse[i,]$typ) +
   geom_point(  data = data_points, aes( x = x, y = y ), 
                colour = "black", size = 2) +
  geom_segment( data = segment_data(data_points), 
                aes(x = x, y = y, xend = xend, yend = yend), 
                linetype = "dotted")

```


### With the valve  `r data_analyse$typ[2]`

```{r positions2-Example-02, echo=FALSE}

  data_analyse$data[[2]] %>%  
    mutate( flow = scales::comma(flow),
            kv = scales::comma(kv),
            sig_1 = round(sig_1,2),
            kv_kvs   = scales::percent(kv_kvs), 
            position = scales::percent(position/100)) %>% 
    select(measurement, p1, p2, flow, dp, kv, sig_1, kv_kvs, position) %>% 
    kbl(caption ="Pressures and flow data at the valve",
        col.names = c("Measu.", "$P_1$" , "$P_2$", "$Flow$", "$\\Delta{P}$", "$K_v$", "$\\sigma_{1}$", "$K_v/K_{vs}$", "Opening")) %>% 
    add_header_above(c("", "$bar$", "$bar$", "$m^3/h$", "$bar$", "$m^3/h$", "--", "%", "%")) %>% 
    kable_classic( bootstrap_options = "striped", 
                   full_width = F, position = "left")%>%
    footnote( symbol = c("NA values in $K_v/K_{vs}$, this means that the required flow capacity is not available.") )

```


```{r kv-kvs2-Example-2, echo=FALSE, fig.cap="Inherent Characteristic of the valve", warning=TRUE}

  i <- 2
  
  data_points <- data_analyse$data[[i]] %>% 
    select( position, kv_kvs) %>% 
    mutate( kv_kvs = kv_kvs * 100) %>% 
    rename( x = position, y = kv_kvs )
  
  plot_kv_kvs(  data_analyse[i,]$kv.b, data_analyse[i,]$kv.d, 
                data_analyse[i,]$kv.e, data_analyse[i,]$typ) +
   geom_point(  data = data_points, aes( x = x, y = y ), 
                colour = "black", size = 2) +
  geom_segment( data = segment_data(data_points), 
                aes(x = x, y = y, xend = xend, yend = yend), 
                linetype = "dotted")

```



### With the valve  `r data_analyse$typ[3]`

```{r positions3-Example-02, echo=FALSE}

  data_analyse$data[[3]] %>%  
    mutate( flow = scales::comma(flow),
            kv = scales::comma(kv),
            sig_1 = round(sig_1,2),
            kv_kvs   = scales::percent(kv_kvs), 
            position = scales::percent(position/100)) %>% 
    select(measurement, p1, p2, flow, dp, kv, sig_1, kv_kvs, position) %>% 
    kbl(caption ="Pressures and flow data at the valve",
        col.names = c("Measu.", "$P_1$" , "$P_2$", "$Flow$", "$\\Delta{P}$", "$K_v$", "$\\sigma_{1}$", "$K_v/K_{vs}$", "Opening")) %>% 
    add_header_above(c("", "$bar$", "$bar$", "$m^3/h$", "$bar$", "$m^3/h$", "--", "%", "%")) %>% 
    kable_classic( bootstrap_options = "striped", 
                   full_width = F, position = "left")%>%
    footnote( symbol = c("NA values in $K_v/K_{vs}$, this means that the required flow capacity is not available.") )

```

## Step 5. Calcultion of the Cavitation's borders.

### For the valve  `r data_analyse$typ[1]`

```{r sigma1-Example-02, echo=FALSE}
  data_analyse$data[[1]] %>%  
    mutate( sig_1  = round(sig_1, 2),
            Sig_i  = round(Sig_i, 2),
            Sig_c  = round(Sig_c, 2), 
            Sig_mv = round(Sig_mv, 2),
            flp_fp    = round(flp_fp, 2),
            position = scales::percent(position/100)) %>% 
    select(measurement,  position, flp_fp, sig_1, Sig_i, Sig_c, Sig_mv, regime) %>% 
    kbl(caption ="Sigma value and cavitation's borders",
        col.names = c("Measu.", "Opening", "$F_{LP}/F_{P}$", "$\\sigma_{1}$", 
                      "$\\sigma_{i}$", "$\\sigma_{c}$", "$\\sigma_{mv}$", "Regime")) %>% 
    add_header_above(c("", "%", "", "", "", "", "", "")) %>% 
    kable_classic( bootstrap_options = "striped",
                   full_width = F, position = "left") %>%
    footnote( symbol = c("NA values in $position$ and $\\sigma$, this means that the required flow capacity is not available.") )
```

```{r sigma1-Example-2, echo=FALSE, warning=FALSE, fig.cap="Sigma"}

  i <- 1

  data_points <- data_analyse$data[[i]] %>% 
    select( position, sig_1) %>% 
    rename( x = position, y = sig_1 )

  plot_sigma( data_analyse[i,]$kv.b, data_analyse[i,]$kv.d, 
              data_analyse[i,]$kv.e, data_analyse[i,]$flps_fps, 
              data_analyse[i,]$typ) +
    geom_point( data = data_points, aes( y = y, x = x ), colour = "black", size = 2) +
    geom_segment(data = segment_data(data_points), aes(x = x, y = y, xend = xend, yend = yend), linetype = "dotted")  

```


### For the valve  `r data_analyse$typ[2]`

```{r sigma2-Example-02, echo=FALSE}
  data_analyse$data[[2]] %>%  
    mutate( sig_1  = round(sig_1, 2),
            Sig_i  = round(Sig_i, 2),
            Sig_c  = round(Sig_c, 2), 
            Sig_mv = round(Sig_mv, 2),
            flp_fp    = round(flp_fp, 2),
            position = scales::percent(position/100)) %>% 
    select(measurement,  position, flp_fp, sig_1, Sig_i, Sig_c, Sig_mv, regime) %>% 
    kbl(caption ="Sigma value and cavitation's borders",
        col.names = c("Measu.", "Opening", "$F_{LP}/F_{P}$", "$\\sigma_{1}$", 
                      "$\\sigma_{i}$", "$\\sigma_{c}$", "$\\sigma_{mv}$", "Regime")) %>% 
    add_header_above(c("", "%", "", "", "", "", "", "")) %>% 
    kable_classic( bootstrap_options = "striped",
                   full_width = F, position = "left") %>%
    footnote( symbol = c("NA values in $position$ and $\\sigma$, this means that the required flow capacity is not available.") )
```


```{r sigma2-Example-2, echo=FALSE, warning=FALSE, fig.cap="Sigma"}

  i <- 2

  data_points <- data_analyse$data[[i]] %>% 
    select( position, sig_1) %>% 
    rename( x = position, y = sig_1 )


  plot_sigma( data_analyse[i,]$kv.b, data_analyse[i,]$kv.d, 
              data_analyse[i,]$kv.e, data_analyse[i,]$flps_fps, 
              data_analyse[i,]$typ) +
    geom_point( data = data_points, aes( y = y, x = x ), 
                colour = "black", size = 2)  +
    geom_segment(data = segment_data(data_points), 
                 aes(x = x, y = y, xend = xend, yend = yend), linetype = "dotted")   

```


### For the valve  `r data_analyse$typ[3]`

```{r sigma3-Example-02, echo=FALSE}
  data_analyse$data[[3]] %>%  
    mutate( sig_1  = round(sig_1, 2),
            Sig_i  = round(Sig_i, 2),
            Sig_c  = round(Sig_c, 2), 
            Sig_mv = round(Sig_mv, 2),
            flp_fp    = round(flp_fp, 2),
            position = scales::percent(position/100)) %>% 
    select(measurement,  position, flp_fp, sig_1, Sig_i, Sig_c, Sig_mv, regime) %>% 
    kbl(caption ="Sigma value and cavitation's borders",
        col.names = c("Measu.", "Opening", "$F_{LP}/F_{P}$", "$\\sigma_{1}$", 
                      "$\\sigma_{i}$", "$\\sigma_{c}$", "$\\sigma_{mv}$", "Regime")) %>% 
    add_header_above(c("", "%", "", "", "", "", "", "")) %>% 
    kable_classic( bootstrap_options = "striped",
                   full_width = F, position = "left") %>%
    footnote( symbol = c("NA values in $position$ and $\\sigma$, this means that the required flow capacity is not available.") )
```

## Step 6. Conclusion

the initial conclusions would be the following: 

  - Only type 1 and 2 valves meet the required conditions; 
  - With the information of the minimum, average and maximum values, only a first approximation of the behavior of the valve is achieved. And it is used for the preselection of the type of valve required. Depending on the importance of the valve for the operation of the system, it is recommended to know all the values corresponding to all the operating scenarios. 
  - This exercise is derived from the actual selection of two control valves on a water treatment plant. The valves are used to control the backwashing of the filters, and for this reason, it is extremely important to review all operating scenarios (see Example xx).
  

<!--chapter:end:08-Praxis.Rmd-->

# Example 3. 

The objective of this exercise is to select from three possible types of control valves (the same valve but different cylinders) the most suitable for the operation of the system.

the conditions are as follows:

  - The diameter of the valve is smaller than the diameter of the pipes, and the piping system requires a constant flow,
  - the pressures vary both upstream and downstream of the valve, and
  - Initially, only three operational points will be evaluated.
  

<!--chapter:end:09-Praxis.Rmd-->

# Example 4. 


<!--chapter:end:10-Praxis.Rmd-->

`r if (knitr::is_html_output()) '
# References {-}
'`

<!--chapter:end:15-references.Rmd-->

